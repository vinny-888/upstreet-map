<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #f5f5f5;
        }

        .tile {
            stroke: #ccc;
            fill: #eee;
        }

        .tile:hover {
            fill: #ddd;
        }

        #info-box {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            background: white;
            border: 1px solid #ccc;
            display: none;
        }

        #overview-map {
            position: absolute;
            top: 20px;
            left: 20px;
            border: 2px solid blue;
        }

        .viewport {
            fill: none;
            stroke: red;
            stroke-width: 2;
        }
    </style>
</head>

<body>
    <div id="map-container" style="position: relative;">
        <svg id="main-map" width="1024" height="1024"></svg>
        <svg id="overview-map" width="256" height="256"></svg>
        
        <div id="map">
            <div id="info-box"> </div>
            <button id="zoom-in" style="position: absolute; right: 10px; top: 10px;">Zoom In</button>
            <button id="zoom-out" style="position: absolute; right: 10px; top: 40px;">Zoom Out</button>
        </div>
    </div>

    <script>
        const width = 1024, height = 1024;
        const svg = d3.select("#main-map");
        const overview = d3.select("#overview-map");
        let currentTileSize = 32;

        const zoom = d3.zoom()
            .scaleExtent([1, 32])  // Adjust the upper limit to 32
            .on("zoom", zoomed);
        svg.call(zoom);

        drawTiles(currentTileSize);
        drawOverview();

        function drawTiles(tileSize) {
            svg.selectAll("*").remove();

            // Calculate the visible bounds based on current transform
            const transform = d3.zoomTransform(svg.node());
            const xStart = Math.floor((0 - transform.x - width / 2) / tileSize / transform.k) * tileSize;
            const xEnd = Math.ceil((width - transform.x - width / 2) / tileSize / transform.k) * tileSize;
            const yStart = Math.floor((0 - transform.y - height / 2) / tileSize / transform.k) * tileSize;
            const yEnd = Math.ceil((height - transform.y - height / 2) / tileSize / transform.k) * tileSize;

            for (let y = yStart; y < yEnd; y += tileSize) {
                for (let x = xStart; x < xEnd; x += tileSize) {
                    svg.append("rect")
                        .attr("class", "tile")
                        .attr("x", x + width / 2)
                        .attr("y", y + height / 2)
                        .attr("width", tileSize)
                        .attr("height", tileSize)
                        .on('click', function() { onTileClick(x, y, tileSize); });
                }
            }

            if (tileSize === 1) {
                // ... [previous code]
            }
        }

        

        function onTileClick(x, y, tileSize) {
            const currentZoomLevel = d3.zoomTransform(svg.node()).k;

            if (currentZoomLevel < 32) {  // Prevent zooming at max zoom level
                const newScale = currentZoomLevel * 2;
                const newX = -x * newScale + width / 2;
                const newY = -y * newScale + height / 2;

                svg.transition().duration(750)
                    .call(zoom.transform, d3.zoomIdentity.translate(newX, newY).scale(newScale));
            } else {
                const infoBox = document.getElementById("info-box");
                infoBox.innerHTML = `Coordinates: (${x},${y}) <br> <a href="https://upstreet.ai/adventure/#${x},${y}" target="_blank">Go to Adventure</a>`;
            }
        }

        function drawOverview() {
            overview.selectAll("*").remove();
            const tileSize = 32;

            for (let y = -512; y < 512; y += tileSize) {
                for (let x = -512; x < 512; x += tileSize) {
                    overview.append("rect")
                        .attr("class", "tile")
                        .attr("x", x / 4 + width / 8)
                        .attr("y", y / 4 + height / 8)
                        .attr("width", tileSize / 4)
                        .attr("height", tileSize / 4);
                }
            }

            overview.append("rect")
                .attr("class", "viewport")
                .attr("width", width / 4)
                .attr("height", height / 4);
        }

        function zoomed() {
            const transform = d3.event.transform;
            svg.attr("transform", transform);

            // Update the overview's viewport rectangle
            overview.select(".viewport")
                .attr("x", -transform.x / 4)
                .attr("y", -transform.y / 4)
                .attr("width", width / transform.k / 4)
                .attr("height", height / transform.k / 4);

            let scale = d3.event.transform.k;

            let targetTileSize;
            if (scale <= 1) targetTileSize = 32;
            else if (scale <= 2) targetTileSize = 16;
            else if (scale <= 4) targetTileSize = 8;
            else if (scale <= 8) targetTileSize = 4;
            else if (scale <= 16) targetTileSize = 2;
            else targetTileSize = 1;

            if (targetTileSize !== currentTileSize) {
                currentTileSize = targetTileSize;
                drawTiles(currentTileSize);
            }
        }

        function updateViewport() {
    const transform = d3.zoomTransform(svg.node());

    // Calculate the visible bounds based on the current transform for the main map
    const xStart = (-transform.x / transform.k + width / 2);
    const yStart = (-transform.y / transform.k + height / 2);
    const xEnd = xStart + width / transform.k;
    const yEnd = yStart + height / transform.k;

    // Translate these coordinates to the overview's scale
    const overviewXStart = xStart / 4;
    const overviewYStart = yStart / 4;
    const overviewXEnd = xEnd / 4;
    const overviewYEnd = yEnd / 4;

    overview.select(".viewport")
        .attr("x", overviewXStart)
        .attr("y", overviewYStart)
        .attr("width", overviewXEnd - overviewXStart)
        .attr("height", overviewYEnd - overviewYStart);
}


        document.getElementById("zoom-in").addEventListener("click", function() {
            zoom.scaleBy(svg.transition().duration(750), 1.5);
        });

        document.getElementById("zoom-out").addEventListener("click", function() {
            zoom.scaleBy(svg.transition().duration(750), 1 / 1.5);
        });

    </script>
</body>

</html>
